{% extends 'base.html.twig' %}

{% block title %}Log in{% endblock %}

{% block body %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">

      <div class="card shadow-lg border-0 rounded">
        <div class="card-header bg-primary text-white text-center">
          <h2 class="mb-0">Welcome Back</h2>
        </div>

        <div class="card-body p-4">

          <div id="loginError" class="alert alert-danger d-none"></div>

          <form id="jwtLoginForm">
            <div class="mb-3">
              <label for="inputEmail" class="form-label">Email address</label>
              <input type="email" id="inputEmail" class="form-control"
                     placeholder="Enter your email" autocomplete="email" required autofocus>
            </div>

            <div class="mb-3">
              <label for="inputPassword" class="form-label">Password</label>
              <input type="password" id="inputPassword" class="form-control"
                     placeholder="Enter your password" autocomplete="current-password" required>
            </div>

            <div class="d-grid">
              <button class="btn btn-success btn-lg" type="submit">
                <i class="bi bi-box-arrow-in-right"></i> Sign in
              </button>
            </div>
          </form>

        </div>
      </div>

      <div class="text-center mt-3">
        <small>Donâ€™t have an account? <a href="{{ path('app_register') }}">Register here</a></small>
      </div>

    </div>
  </div>
</div>

<script>
  const form = document.getElementById('jwtLoginForm');
  const errorBox = document.getElementById('loginError');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorBox.classList.add('d-none');
    errorBox.textContent = '';

    const email = document.getElementById('inputEmail').value.trim();
    const password = document.getElementById('inputPassword').value;

    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      let data = {};
      try {
        data = await res.json();
      } catch (e) {
        data = {};
      }

      if (!res.ok) {
        errorBox.textContent = data.message || 'Login failed (check email/password)';
        errorBox.classList.remove('d-none');
        return;
      }

      if (!data.token) {
        errorBox.textContent = 'Token not received from server';
        errorBox.classList.remove('d-none');
        return;
      }

      localStorage.setItem('jwt_token', data.token);

      // Redirect after login
      window.location.href = '/todo';
    } catch (err) {
      errorBox.textContent = 'Network error. Please try again.';
      errorBox.classList.remove('d-none');
    }
  });
</script>
{% endblock %}